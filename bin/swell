#!/usr/bin/env python3

import sys
import logging


sys.path.insert(0, "./")
from swell import config
from swell.package import dump_packages, load_packages, resolve_deps
from swell.task import Task
from swell.logger import get_logger
from docopt import docopt

cli = """
Usage:
    swell list
    swell install <package>
"""

log = get_logger('SWELL')
packages = load_packages()


def list_packages():
    dump_packages()


def install_package(package):
    if package in packages:
        task = Task(packages[package])
        task.run()
    else:
        log.error('{} not found!'.format(package))


def build_temp_system():
    log.info('Building temp system')
    config.setup_temp_build_env()
    packages_to_build = resolve_deps('build-temp-system')
    for p in packages_to_build:
        task = Task(packages[p])
        task.run()
        a = raw_input('pause!')


def build_base_system():
    log.info('Building base system')
    config.setup_base_build_env()
    packages_to_build = resolve_deps('build-base-system')
    for p in packages_to_build:
        task = Task(packages[p])
        task.run()


if __name__ == '__main__':
    arguments = docopt(cli)
    # package

    if arguments['list']:
        list_packages()
    # install
    elif arguments['install']:
        if arguments['<package>']:
            install_package(arguments['<package>'])
    # build_temp_system
    elif arguments['build_temp_system']:
        build_temp_system()
    # build_temp_system
    elif arguments['build_base_system']:
        build_base_system()
